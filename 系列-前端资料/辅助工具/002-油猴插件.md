002 - 油猴插件
===

> Create by **jsliang** on **2021-12-23 08:57:06**  
> Recently revised in **2021-12-23 08:57:06**

作为一枚喜爱折腾的咸鱼，看到一些新产品发布，难免先体验一番。

但是，如果这个产品不是很满足你的想法，然后你又不想走反馈流程，毕竟要等几个月才能体验新功能。

所以，这时候肯定想方设法 DIY 它！

## 一 既定目标

本次操刀的是「金山文档」的新产品「文档」

* [ ] 支持模板搜索功能
* [ ] 支持导入自定义模板
* [ ] 右键搜索功能
  * [ ] 页内搜索
  * [ ] 页外搜索

## 二 实现情况

油猴脚本（Tampermonkey）是一个非常流行的浏览器扩展，它可以运行由广大社区编写的扩展脚本，来实现各式各样的功能，常见的去广告、修改样式文件、甚至是下载视频.

> 它可能需要使用一丁点的小手段，才能下载插件和访问官网，当然，如果找不到好的方式，你可以直接 call **jsliang**，让他给你推荐个小工具

* 下载：[Chrome 拓展工具：Tampermonkey](https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo?hl=zh)
* 使用说明：[Tampermonkey 首页](https://www.tampermonkey.net/index.php?version=4.13&ext=dhdg&updated=true)

当然，有些小伙伴想偷懒，直接看从安装到建立第一个脚本，可以看下面 GIF：

![图](./img/002-01.gif)

```js
// ==UserScript==
// @name         金山文档油猴插件
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  支持金山文档各个组件新功能拓展
// @author       jsliang
// @match        https://www.kdocs.cn/*
// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==
// @grant        none
// ==/UserScript==

(function(){
    'use strict';

    document.head.insertAdjacentHTML("beforeend", `
<style>
    .template-item-container-search {
        outline-style: none;
        border: 1px solid #ccc;
        border-radius: 3px;
        padding: 5px 14px;
        width: 100%;
        font-size: 14px;
        font-weight: 700;
        font-family: 'Microsoft soft';
    }
</style>
    `);

    /* ------ 模板搜索功能 ------*/
    const templateTitlelist = []; // 存储模板标题列表

    // 定时 2s 获取所有模板卡片
    setTimeout(() => {
        const templates = document.querySelectorAll('.otl-template-container .template-card-item'); // 最后一个是 More 更多
        // 兼容下
        if (templates.length) {
            // 设置最后一个的点击
            templates[templates.length - 1].onclick = (e) => {
                // 定时 200ms 获取内部所有列表
                setTimeout(() => {
                    // 将未展开的先展开
                    document.querySelectorAll('.template-dropdown-container').forEach(item => {
                        const i = item.querySelector('.template-group-icon');
                        if (!i.classList.contains('selected')) {
                            i.click();
                        }
                    });

                    // 再将标题放到 set 中存储
                    const containers = document.querySelectorAll('.template-item-container');
                    for (let i = 0; i < containers.length; i++) {
                        templateTitlelist.push(containers[i].getAttribute('title'));
                    }

                    // 添加搜索框
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'template-item-container-search';
                    input.placeholder = '搜索模板标题...';
                    input.oninput = (e) => {
                        const value = e.target.value;
                        // 查找过滤清单
                        for (let i = 0; i < templateTitlelist.length; i++) {
                            if (!templateTitlelist[i].includes(value)) {
                                containers[i].style.display = 'none';
                            } else {
                                containers[i].style.display = 'flex';
                            }
                        }
                    };
                    const insertedNode = document.querySelector('.template-sider').insertBefore(input, document.querySelector('.template-dropdown-container'));
                    setTimeout(() => {
                       insertedNode.focus(); // 自动聚焦
                    }, 1000);
                }, 300);
            };
        }
    }, 2000);
    /* ------ 模板搜索功能 End ------*/

}());
```

## 三 参考文献

* [【SegmentFault】techstay - 油猴脚本编写教程](https://segmentfault.com/a/1190000021654926)

---

> jsliang 的文档库由 [梁峻荣](https://github.com/LiangJunrong) 采用 [知识共享 署名-非商业性使用-相同方式共享 4.0 国际 许可协议](http://creativecommons.org/licenses/by-nc-sa/4.0/) 进行许可。<br/>基于 [https://github.com/LiangJunrong/document-library](https://github.com/LiangJunrong/document-library) 上的作品创作。<br/>本许可协议授权之外的使用权限可以从 [https://creativecommons.org/licenses/by-nc-sa/2.5/cn/](https://creativecommons.org/licenses/by-nc-sa/2.5/cn/) 处获得。
