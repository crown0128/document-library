加减危机 —— 为什么会出现这样的结果？
===

> Create by **jsliang** on **2019-11-01 19:48:33**  
> Recently revised in **2019-11-22 08:42:51**

## <a name="chapter-one" id="chapter-one"></a>一 目录

**不折腾的前端，和咸鱼有什么区别**

| 目录 |
| --- | 
| [一 目录](#chapter-one) | 
| <a name="catalog-chapter-two" id="catalog-chapter-two"></a>[二 前言](#chapter-two) |
| <a name="catalog-chapter-three" id="catalog-chapter-three"></a>[三 二维降一维](#chapter-three) |
| <a name="catalog-chapter-four" id="catalog-chapter-four"></a>[四 递归降维](#chapter-four) |
| <a name="catalog-chapter-five" id="catalog-chapter-five"></a>[五 flat() 降维](#chapter-five) |
| <a name="catalog-chapter-six" id="catalog-chapter-six"></a>[六 参考文献](#chapter-six) |

## <a name="chapter-two" id="chapter-two"></a>二 前言

> [返回目录](#chapter-one)

在日常工作计算中，我们如履薄冰，但是 JavaScript 总能给我们这样那样的 surprise~

1. 0.1 + 0.2 = ？
2. 1 - 0.9 = ？

如果小伙伴给出内心的结果：

1. 0.1 + 0.2 = 0.3
2. 1 - 0.9 = 0.1

那么小伙伴会被事实狠狠地扇脸：

```js
console.log(0.1 + 0.2); // 0.30000000000000004
console.log(1 - 0.9); // 0.09999999999999998
```

为什么会出现这种情况呢？咱们一探究竟！

```js
/**
 * @name 获取数字中小数点右侧的长度
 * @param {Number} 需要拆分的数字
 */
const getDigitRightLength = (num) => {
  return (String(num).split('.')[1] || '').length;
};

/**
 * @name 把小数转成整数
 * @param {*number} num 输入数
 */
const float2Fixed = (num) => {
  return Number(String(num).replace('.', ''));
}

/**
 * @name 小数加法优化
 * @description 0.1 + 0.2 !== 0.3
 * @param {*} leftNum 参数 1
 * @param {*} rightNum 参数 2
 */
const accAdd = (leftNum, rightNum) => {
  console.log('------\n加法：');
  if (Number.isInteger(leftNum) || Number.isInteger(rightNum)) {
    return leftNum + rightNum;
  }

  const leftNumRightLength = getDigitRightLength(leftNum);
  const rightNumRightLength = getDigitRightLength(rightNum);
  const differenceValue = Math.abs(leftNumRightLength - rightNumRightLength);
  const multiplyingValue = Math.pow(10, Math.max(leftNumRightLength, rightNumRightLength));

  const cm = Math.pow(10, differenceValue);
  if (differenceValue > 0 && leftNumRightLength > rightNumRightLength) {
    leftNum = float2Fixed(leftNum);
    rightNum = float2Fixed(rightNum) * cm;
  } else if(differenceValue > 0 && leftNumRightLength < rightNumRightLength) {
    leftNum = float2Fixed(leftNum) * cm;
    rightNum = float2Fixed(rightNum);
  } else {
    leftNum = float2Fixed(leftNum);
    rightNum = float2Fixed(rightNum);
  }
  return (leftNum + rightNum) / multiplyingValue;
};

console.log(accAdd(1, 2)); // 3
console.log(accAdd(0.1, 0.2)); // 0.30000000000000004 => 0.3
console.log(accAdd(0.123, 0.11)); // 0.23299999999999998 => 0.233
```

* [《JavaScript 浮点数陷阱及解法 —— camsong》](https://github.com/camsong/blog/issues/9)
* [《GitHub number-precision —— nefe》](https://github.com/nefe/number-precision/blob/master/src/index.ts)
* [《JS中浮点数精度问题 —— 谢小飞》](https://juejin.im/post/5aa1395c6fb9a028df223516)
* [《JavaScript 浮点数运算的精度问题 —— WEB前端开发》](https://www.html.cn/archives/7340)

---

> **jsliang** 广告推送：  
> 也许小伙伴想了解下云服务器  
> 或者小伙伴想买一台云服务器  
> 或者小伙伴需要续费云服务器  
> 欢迎点击 **[云服务器推广](https://github.com/LiangJunrong/document-library/blob/master/other-library/Monologue/%E7%A8%B3%E9%A3%9F%E8%89%B0%E9%9A%BE.md)** 查看！

[![图](../../../public-repertory/img/z-small-seek-ali-3.jpg)](https://promotion.aliyun.com/ntms/act/qwbk.html?userCode=w7hismrh)
[![图](../../../public-repertory/img/z-small-seek-tencent-2.jpg)](https://cloud.tencent.com/redirect.php?redirect=1014&cps_key=49f647c99fce1a9f0b4e1eeb1be484c9&from=console)

> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">jsliang 的文档库</span> 由 <a xmlns:cc="http://creativecommons.org/ns#" href="https://github.com/LiangJunrong/document-library" property="cc:attributionName" rel="cc:attributionURL">梁峻荣</a> 采用 <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享 署名-非商业性使用-相同方式共享 4.0 国际 许可协议</a>进行许可。<br />基于<a xmlns:dct="http://purl.org/dc/terms/" href="https://github.com/LiangJunrong/document-library" rel="dct:source">https://github.com/LiangJunrong/document-library</a>上的作品创作。<br />本许可协议授权之外的使用权限可以从 <a xmlns:cc="http://creativecommons.org/ns#" href="https://creativecommons.org/licenses/by-nc-sa/2.5/cn/" rel="cc:morePermissions">https://creativecommons.org/licenses/by-nc-sa/2.5/cn/</a> 处获得。